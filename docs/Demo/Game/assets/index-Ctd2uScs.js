(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();const q=new WeakMap;let J=1;function S(h){const e=q.get(h);if(e!=null)return e;const t=J++;return q.set(h,t),t}class Z{constructor(){this.q=[]}spawn(e){this.q.push({k:"spawn",init:e})}spawnBundle(...e){this.spawn(t=>{for(const[s,n]of e)this.add(t,s,n)})}despawn(e){this.q.push({k:"despawn",e})}despawnBundle(e){for(const t of e)this.despawn(t)}add(e,t,s){this.q.push({k:"add",e,ctor:t,value:s})}addBundle(e,...t){for(const[s,n]of t)this.add(e,s,n)}remove(e,t){this.q.push({k:"remove",e,ctor:t})}removeBundle(e,...t){for(const s of t)this.remove(e,s)}hasPending(){return this.q.length>0}drain(){const e=this.q;return this.q=[],e}}class K{constructor(e,t){this.cols=new Map,this.entities=[],this.id=e,this.sig=t;for(const s of t)this.cols.set(s,[])}addRow(e){const t=this.entities.length;return this.entities.push(e),t}removeRow(e){const t=this.entities.length-1;if(e<0||e>t)throw new Error(`removeRow out of range: ${e}`);if(e!==t){const s=this.entities[t];this.entities[e]=s,this.entities.pop();for(const[,n]of this.cols)n[e]=n[t],n.pop();return s}this.entities.pop();for(const[,s]of this.cols)s.pop();return null}has(e){return this.cols.has(e)}column(e){const t=this.cols.get(e);if(!t)throw new Error(`Archetype ${this.id} missing column for type ${e}`);return t}}class ee{constructor(){this._nextId=1,this._free=[],this.meta=[]}create(){let e;if(this._free.length>0){e=this._free.pop();const t=this.meta[e];return t.alive=!0,t.gen+=1,t.arch=0,t.row=0,{id:e,gen:t.gen}}return e=this._nextId++,this.meta[e]={gen:1,alive:!0,arch:0,row:0},{id:e,gen:1}}isAlive(e){const t=this.meta[e.id];return!!t&&t.alive&&t.gen===e.gen}kill(e){const t=this.meta[e.id];!t||!t.alive||t.gen!==e.gen||(t.alive=!1,this._free.push(e.id))}snapshotAllocator(){const e=[];for(let t=1;t<this.meta.length;t++){const s=this.meta[t];s&&e.push([t,s.gen])}return{nextId:this._nextId,free:this._free.slice(),generations:e}}restoreAllocator(e){if(!Number.isInteger(e.nextId)||e.nextId<1)throw new Error(`Invalid snapshot allocator.nextId: ${e.nextId}`);const t=new Set;this.meta.length=0;for(const n of e.generations){const r=n[0],o=n[1];if(!Number.isInteger(r)||r<=0)throw new Error(`Invalid snapshot allocator generations id: ${r}`);if(!Number.isInteger(o)||o<=0)throw new Error(`Invalid snapshot allocator generation for id ${r}: ${o}`);if(r>=e.nextId)throw new Error(`Invalid snapshot allocator generation id ${r}: must be < nextId (${e.nextId})`);if(t.has(r))throw new Error(`Duplicate snapshot allocator generation entry for id ${r}`);t.add(r),this.meta[r]={gen:o,alive:!1,arch:0,row:0}}const s=new Set;for(const n of e.free){if(!Number.isInteger(n)||n<=0)throw new Error(`Invalid snapshot allocator free id: ${n}`);if(n>=e.nextId)throw new Error(`Invalid snapshot allocator free id ${n}: must be < nextId (${e.nextId})`);if(!t.has(n))throw new Error(`Invalid snapshot allocator free id ${n}: missing generation entry`);if(s.has(n))throw new Error(`Duplicate snapshot allocator free id ${n}`);s.add(n)}this._nextId=e.nextId,this._free=e.free.slice()}}class te{constructor(){this._read=[],this._write=[]}emit(e){this._write.push(e)}drain(e){const t=this._read;for(const s of t)e(s);this.clear()}values(){return this._read}count(){return this._read.length}clear(){this._read.length=0}clearAll(){this._read.length=0,this._write.length=0}swapBuffers(){if(this._write.length===0&&this._read.length===0)return;const e=this._read;this._read=this._write,this._write=e,this._write.length=0}}function se(h){return h.join(",")}function ne(h,e){const t=h.slice();let s=0;for(;s<t.length&&t[s]<e;)s++;return t[s]===e||t.splice(s,0,e),t}function ie(h,e){const t=h.slice(),s=t.indexOf(e);return s>=0&&t.splice(s,1),t}function z(h,e){let t=0,s=0;for(;t<h.length&&s<e.length;){const n=h[t],r=e[s];if(n===r){t++,s++;continue}if(n<r){t++;continue}return!1}return s===e.length}const T="archetype-ecs/world-snapshot@1";class re{constructor(){this.componentSnapshotByCtor=new Map,this.componentSnapshotCtorByKey=new Map,this.resourceSnapshotByCtor=new Map,this.resourceSnapshotCtorByKey=new Map}registerComponentSnapshot(e,t,s){const n=this._normalizeSnapshotKey(s.key,"component"),r=this.componentSnapshotCtorByKey.get(n);if(r&&r!==t)throw new Error(`registerComponentSnapshot(${n}) failed: key already used by ${e.formatCtor(r)}`);const o=this.componentSnapshotByCtor.get(t);o&&o.key!==n&&this.componentSnapshotCtorByKey.delete(o.key),this.componentSnapshotByCtor.set(t,{key:n,tid:S(t),serialize:a=>s.serialize(a),deserialize:a=>s.deserialize(a)}),this.componentSnapshotCtorByKey.set(n,t)}unregisterComponentSnapshot(e){const t=this.componentSnapshotByCtor.get(e);return t?(this.componentSnapshotByCtor.delete(e),this.componentSnapshotCtorByKey.delete(t.key),!0):!1}registerResourceSnapshot(e,t,s){const n=this._normalizeSnapshotKey(s.key,"resource"),r=this.resourceSnapshotCtorByKey.get(n);if(r&&r!==t)throw new Error(`registerResourceSnapshot(${n}) failed: key already used by ${e.formatCtor(r)}`);const o=this.resourceSnapshotByCtor.get(t);o&&o.key!==n&&this.resourceSnapshotCtorByKey.delete(o.key),this.resourceSnapshotByCtor.set(t,{key:n,serialize:a=>s.serialize(a),deserialize:a=>s.deserialize(a)}),this.resourceSnapshotCtorByKey.set(n,t)}unregisterResourceSnapshot(e){const t=this.resourceSnapshotByCtor.get(e);return t?(this.resourceSnapshotByCtor.delete(e),this.resourceSnapshotCtorByKey.delete(t.key),!0):!1}snapshot(e){e.ensureNotIterating("snapshot"),e.commands.hasPending()&&e.flush();const t=[];for(const[,a]of this.componentSnapshotByCtor)t.push(a);t.sort((a,i)=>a.key.localeCompare(i.key));const s=new Map;for(const a of e.archetypes){if(!a)continue;const i=[];for(const c of t)a.has(c.tid)&&i.push({type:c.key,column:a.column(c.tid),serialize:c.serialize});s.set(a.id,i)}const n=[];for(let a=1;a<e.entities.meta.length;a++){const i=e.entities.meta[a];if(!i||!i.alive)continue;const c=s.get(i.arch)??[],u=new Array(c.length);for(let l=0;l<c.length;l++){const d=c[l];u[l]={type:d.type,data:d.serialize(d.column[i.row])}}n.push({id:a,gen:i.gen,components:u})}const r=[];for(const[a,i]of this.resourceSnapshotByCtor)r.push({ctor:a,reg:i});r.sort((a,i)=>a.reg.key.localeCompare(i.reg.key));const o=[];for(const a of r)e.resources.has(a.ctor)&&o.push({type:a.reg.key,data:a.reg.serialize(e.resources.get(a.ctor))});return{format:T,allocator:e.entities.snapshotAllocator(),entities:n,resources:o}}restore(e,t){if(e.ensureNotIterating("restore"),t.format!==T)throw new Error(`Unsupported world snapshot format "${t.format}". Expected "${T}".`);e.commands.drain();for(const o of e.eventChannels.values())o.clearAll();e.resources.clear(),e.entities.restoreAllocator(t.allocator),e.resetArchetypes();const s=new Set;for(const o of t.resources){if(s.has(o.type))throw new Error(`Duplicate snapshot resource type "${o.type}"`);s.add(o.type);const a=this.resourceSnapshotCtorByKey.get(o.type);if(!a)throw new Error(`Missing resource snapshot codec for "${o.type}". Register it before restore().`);const i=this.resourceSnapshotByCtor.get(a);e.resources.set(a,i.deserialize(o.data))}const n=new Set(t.allocator.free),r=new Set;for(const o of t.entities){if(!Number.isInteger(o.id)||o.id<=0)throw new Error(`Invalid snapshot entity id: ${o.id}`);if(!Number.isInteger(o.gen)||o.gen<=0)throw new Error(`Invalid snapshot entity generation for id ${o.id}: ${o.gen}`);if(r.has(o.id))throw new Error(`Duplicate snapshot entity id ${o.id}`);if(r.add(o.id),n.has(o.id))throw new Error(`Invalid snapshot: entity id ${o.id} is both alive and free`);const a=e.entities.meta[o.id];if(!a)throw new Error(`Invalid snapshot: missing allocator generation entry for entity id ${o.id}. Ensure snapshot.allocator.generations includes all alive ids.`);const i=new Map,c=new Set;for(const f of o.components){if(c.has(f.type))throw new Error(`Duplicate component type "${f.type}" on entity ${o.id}`);c.add(f.type);const g=this.componentSnapshotCtorByKey.get(f.type);if(!g)throw new Error(`Missing component snapshot codec for "${f.type}". Register it before restore().`);const p=this.componentSnapshotByCtor.get(g);i.set(p.tid,p.deserialize(f.data))}const u=Array.from(i.keys()).sort((f,g)=>f-g),l=e.getOrCreateArchetype(u),d=l.addRow({id:o.id,gen:o.gen});for(const f of u)l.column(f).push(i.get(f));a.alive=!0,a.gen=o.gen,a.arch=l.id,a.row=d}}_normalizeSnapshotKey(e,t){const s=e.trim();if(s.length===0)throw new Error(`register${t==="component"?"Component":"Resource"}Snapshot() failed: codec.key must be a non-empty string`);return s}}class oe{constructor(e={}){this.root=null,this.header=null,this.toggleButton=null,this.debugToggleButton=null,this.content=null,this.text=null,this.canvas=null,this.ctx=null,this.resizeObserver=null,this.isExpanded=!0,this.debugLoggingEnabled=!1,this.isInitialized=!1,this.debugingEnabled=!1,this._profilingEnabled=!0,this._frameCounter=0,this._lastDt=0,this._lastFrameMs=0,this._phaseMs=new Map,this._systemMs=new Map,this._historyCapacity=120,this._histDt=[],this._histFrameMs=[],this._histPhaseMs=new Map,this._histSystemMs=new Map,this.isDragging=!1,this.dragOffsetX=0,this.dragOffsetY=0,this.opts={parent:e.parent??null,left:e.left??8,top:e.top??8,width:e.width??320,height:e.height??80,targetFrameMs:e.targetFrameMs??16.67,slowFrameMs:e.slowFrameMs??20,maxSamples:e.maxSamples??240}}initializeDom(){if(this.isInitialized||!this.opts.parent)return;this.isInitialized=!0,this.root=document.createElement("div"),this.root.style.position="fixed",this.root.style.left=`${this.opts.left}px`,this.root.style.top=`${this.opts.top}px`,this.root.style.zIndex="9999",this.root.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace",this.root.style.fontSize="12px",this.root.style.color="#d7e3ff",this.root.style.background="rgba(10, 14, 24, 0.75)",this.root.style.border="1px solid rgba(140, 170, 255, 0.25)",this.root.style.borderRadius="8px",this.root.style.backdropFilter="blur(2px)",this.root.style.maxWidth="calc(100vw - 16px)",this.header=document.createElement("div"),this.header.style.display="flex",this.header.style.alignItems="center",this.header.style.padding="8px",this.header.style.cursor="pointer",this.header.style.pointerEvents="auto",this.header.style.userSelect="none";const e=document.createElement("span");e.textContent="ECS Stats",e.style.fontWeight="600",e.style.userSelect="none",e.style.marginRight="10px",this.toggleButton=document.createElement("button"),this.toggleButton.textContent="âˆ’",this.toggleButton.style.background="rgba(140, 170, 255, 0.15)",this.toggleButton.style.border="1px solid rgba(140, 170, 255, 0.3)",this.toggleButton.style.borderRadius="4px",this.toggleButton.style.color="#d7e3ff",this.toggleButton.style.width="24px",this.toggleButton.style.height="24px",this.toggleButton.style.cursor="pointer",this.toggleButton.style.fontSize="16px",this.toggleButton.style.lineHeight="1",this.toggleButton.style.padding="0",this.toggleButton.style.display="flex",this.toggleButton.style.alignItems="center",this.toggleButton.style.justifyContent="center",this.toggleButton.style.userSelect="none",this.toggleButton.addEventListener("mouseenter",()=>{this.toggleButton.style.background="rgba(140, 170, 255, 0.25)"}),this.toggleButton.addEventListener("mouseleave",()=>{this.toggleButton.style.background="rgba(140, 170, 255, 0.15)"}),this.toggleButton.addEventListener("click",s=>{s.stopPropagation(),this.toggle()}),this.debugToggleButton=this.createDebugToggleButton("ðŸ”‡","Toggle console debug logging"),this.debugToggleButton.style.marginRight="5px",this.debugToggleButton.addEventListener("click",s=>{s.stopPropagation(),this.toggleDebugLogging()}),this.header.appendChild(e),this.header.appendChild(this.debugToggleButton),this.header.appendChild(this.toggleButton),this.content=document.createElement("div"),this.content.style.padding="0 8px 8px 8px",this.content.style.pointerEvents="none",this.text=document.createElement("pre"),this.text.style.margin="0 0 6px 0",this.text.style.whiteSpace="pre",this.text.style.lineHeight="1.2",this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.canvas.style.borderRadius="6px",this.canvas.style.background="rgba(255,255,255,0.04)",this.canvas.style.width="100%",this.canvas.style.height="auto";const t=this.canvas.getContext("2d");if(!t)throw new Error("StatsOverlay: canvas 2D context not available");this.ctx=t,this.content.appendChild(this.text),this.content.appendChild(this.canvas),this.root.appendChild(this.header),this.root.appendChild(this.content),this.opts.parent.appendChild(this.root),this.resizeCanvas(),this.resizeObserver=new ResizeObserver(()=>this.resizeCanvas()),this.resizeObserver.observe(this.root),this.setupDrag()}setDebugging(e){e?typeof document<"u"&&(this.opts.parent=this.opts.parent??document.body,this.initializeDom()):this.destroyOverlay(),this.debugingEnabled=e}setProfilingEnabled(e){this._profilingEnabled=e}setProfilingHistorySize(e){this._historyCapacity=Math.max(0,Math.floor(e)),this._trimHistoryToCapacity()}_trimHistoryToCapacity(){const e=this._historyCapacity,t=s=>{if(e===0){s.length=0;return}for(;s.length>e;)s.shift()};t(this._histDt),t(this._histFrameMs);for(const s of this._histPhaseMs.values())t(s);for(const s of this._histSystemMs.values())t(s)}_pushSeriesFrame(e,t){const s=this._histFrameMs.length;for(const[n,r]of e){const o=t.get(n)??0;if(r.push(o),this._historyCapacity===0)r.length=0;else for(;r.length>this._historyCapacity;)r.shift()}for(const[n,r]of t){if(e.has(n))continue;const o=new Array(s).fill(0);if(o.push(r),e.set(n,o),this._historyCapacity===0)o.length=0;else for(;o.length>this._historyCapacity;)o.shift()}}_profBeginFrame(e){return this._frameCounter++,this._lastDt=e,this._phaseMs.clear(),this._systemMs.clear(),this._profilingEnabled?performance.now():(this._lastFrameMs=0,0)}_profEndFrame(e){this._profilingEnabled&&(this._lastFrameMs=performance.now()-e,this._histDt.push(this._lastDt),this._histFrameMs.push(this._lastFrameMs),this._trimHistoryToCapacity(),this._pushSeriesFrame(this._histPhaseMs,this._phaseMs),this._pushSeriesFrame(this._histSystemMs,this._systemMs))}_profAddPhase(e,t){this._profilingEnabled&&this._phaseMs.set(e,(this._phaseMs.get(e)??0)+t)}_profAddSystem(e,t){this._profilingEnabled&&this._systemMs.set(e,(this._systemMs.get(e)??0)+t)}createDebugToggleButton(e,t){const s=document.createElement("button");return s.textContent=e,s.title=t,s.style.background="rgba(140, 170, 255, 0.15)",s.style.border="1px solid rgba(140, 170, 255, 0.3)",s.style.borderRadius="4px",s.style.color="#d7e3ff",s.style.width="24px",s.style.height="24px",s.style.cursor="pointer",s.style.fontSize="12px",s.style.lineHeight="1",s.style.padding="0",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",s.style.userSelect="none",s.addEventListener("mouseenter",()=>{s.style.background="rgba(140, 170, 255, 0.25)"}),s.addEventListener("mouseleave",()=>{s.style.background="rgba(140, 170, 255, 0.15)"}),s}toggleDebugLogging(){this.debugLoggingEnabled=!this.debugLoggingEnabled,this.debugToggleButton.textContent=this.debugLoggingEnabled?"ðŸ”Š":"ðŸ”‡",this.debugToggleButton.title=this.debugLoggingEnabled?"Console debug logging ON (click to disable)":"Console debug logging OFF (click to enable)"}setupDrag(){const e=n=>{if(n.target===this.toggleButton||n.target===this.debugToggleButton)return;this.isDragging=!0;const r=this.root.getBoundingClientRect();this.dragOffsetX=n.clientX-r.left,this.dragOffsetY=n.clientY-r.top,this.header.style.cursor="grabbing",document.body.style.userSelect="none"},t=n=>{if(!this.isDragging)return;const r=n.clientX-this.dragOffsetX,o=n.clientY-this.dragOffsetY,a=this.root.getBoundingClientRect(),i=window.innerWidth-a.width,c=window.innerHeight-a.height;this.root.style.left=`${Math.max(0,Math.min(r,i))}px`,this.root.style.top=`${Math.max(0,Math.min(o,c))}px`},s=()=>{this.isDragging&&(this.isDragging=!1,this.header.style.cursor="grab",document.body.style.userSelect="")};this.header.addEventListener("mousedown",e),document.addEventListener("mousemove",t),document.addEventListener("mouseup",s),this._dragCleanup=()=>{this.header.removeEventListener("mousedown",e),document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",s)}}resizeCanvas(){if(!this.canvas||!this.ctx)return;const e=window.devicePixelRatio||1,t=this.canvas.getBoundingClientRect(),s=Math.min(this.opts.width,t.width||this.opts.width),n=this.opts.height;this.canvas.width=s*e,this.canvas.height=n*e,this.canvas.style.width=`${s}px`,this.canvas.style.height=`${n}px`,this.ctx.scale(e,e)}toggle(){!this.content||!this.toggleButton||(this.isExpanded=!this.isExpanded,this.content.style.display=this.isExpanded?"block":"none",this.toggleButton.textContent=this.isExpanded?"âˆ’":"+")}destroyOverlay(){this._dragCleanup?.(),this.resizeObserver?.disconnect(),this.root?.remove(),this.isInitialized=!1}updateOverlay(e,t){!this.debugingEnabled||!this.isInitialized||this.render(e,t)}render(e,t){if(!this.debugingEnabled||!this.text||!this.ctx)return;const s=Object.entries(e.phaseMs).sort((n,r)=>r[1]-n[1]).slice(0,6).map(([n,r])=>`${n}=${r.toFixed(2)}ms`).join(" ");this.text.textContent=`Frame ${e.frame}
Archetypes: ${e.archetypes}
Rows: ${e.rows}
Alive entities: ${e.aliveEntities}
Systems: ${e.systems}
Resources: ${e.resources}
Event channels: ${e.eventChannels}
Pending commands: ${String(e.pendingCommands)}
dt=${(e.dt*1e3).toFixed(2)}ms frame=${e.frameMs.toFixed(2)}ms
Phases: ${s}`,this.debugLoggingEnabled&&console.debug(`Phases: ${s}`),this.drawFrameGraph(t)}drawFrameGraph(e){const t=this.ctx,s=window.devicePixelRatio||1,n=this.canvas.width/s,r=this.canvas.height/s;t.clearRect(0,0,n,r);const o=Math.min(e.size,this.opts.maxSamples),a=e.frameMs.slice(e.size-o),i=Math.max(33.33,this.opts.targetFrameMs,...a),c=B=>r-B/i*(r-10)-5,u="rgba(255,255,255,0.18)",l="rgba(110,200,255,0.85)",d="rgba(255,110,110,0.85)",f="rgba(215,227,255,0.90)",g="rgba(10, 14, 24, 0.55)";t.strokeStyle=u,t.beginPath(),t.moveTo(0,c(this.opts.targetFrameMs)),t.lineTo(n,c(this.opts.targetFrameMs)),t.stroke();const p=Math.max(1,Math.floor(n/Math.max(1,a.length))),A=Math.max(1,p);for(let B=0;B<a.length;B++){const P=a[B],G=B*p,L=c(P),Q=r-L,V=P>this.opts.slowFrameMs;t.fillStyle=V?d:l,t.fillRect(G,L,A,Q)}t.save(),t.font="11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace",t.textBaseline="middle",t.fillStyle=f;const E=6,w=14,R=`Target ${this.opts.targetFrameMs.toFixed(2)}ms`,v=`OK â‰¤ ${this.opts.slowFrameMs.toFixed(0)}ms`,D=`Slow > ${this.opts.slowFrameMs.toFixed(0)}ms`,W=t.measureText(R).width,Y=t.measureText(v).width,j=t.measureText(D).width,U=Math.ceil(Math.max(W,Y,j)+40),X=E*2+w*3;t.fillStyle=g,t.fillRect(6,6,U,X);const x=6+E;let _=6+E+w*.5;t.strokeStyle=u,t.lineWidth=2,t.beginPath(),t.moveTo(x,_),t.lineTo(x+18,_),t.stroke(),t.fillStyle=f,t.fillText(R,x+24,_),_+=w,t.fillStyle=l,t.fillRect(x,_-5,18,10),t.fillStyle=f,t.fillText(v,x+24,_),_+=w,t.fillStyle=d,t.fillRect(x,_-5,18,10),t.fillStyle=f,t.fillText(D,x+24,_),t.restore()}}class $ extends oe{constructor(e){super(e?.statsOverlayOptions),this.entities=new ee,this.archetypes=[],this.archByKey=new Map,this.systems=[],this.commands=new Z,this._iterateDepth=0,this.resources=new Map,this.eventChannels=new Map,this.snapshotStore=new re,this._scheduleSystems=new Map,this._resetArchetypes()}statsHistory(){const e=Object.create(null);for(const[s,n]of this._histPhaseMs)e[s]=n;const t=Object.create(null);for(const[s,n]of this._histSystemMs)t[s]=n;return{capacity:this._historyCapacity,size:this._histFrameMs.length,dt:this._histDt,frameMs:this._histFrameMs,phaseMs:e,systemMs:t}}stats(){let e=0;for(let a=1;a<this.entities.meta.length;a++){const i=this.entities.meta[a];i&&i.alive&&e++}let t=0,s=0;for(const a of this.archetypes)a&&(t++,s+=a.entities.length);const n=Object.create(null);for(const[a,i]of this._phaseMs)n[a]=i;const r=Object.create(null);for(const[a,i]of this._systemMs)r[a]=i;let o=this.systems.length;return this._scheduleSystems.size>0&&(o+=this._scheduleSystems.size),{aliveEntities:e,archetypes:t,rows:s,systems:o,resources:this.resources.size,eventChannels:this.eventChannels.size,pendingCommands:this.commands.hasPending(),frame:this._frameCounter,dt:this._lastDt,frameMs:this._lastFrameMs,phaseMs:n,systemMs:r}}cmd(){return this.commands}addSystem(e){return this.systems.push(e),this}update(e){this._scheduleSystems.size>0&&this._warnAboutLifecycleConflict("World.update");const t=this._profBeginFrame(e);this._iterateDepth++;try{for(const s of this.systems)if(this._profilingEnabled){const n=performance.now();s(this,e);const r=s.name&&s.name.length>0?s.name:"<anonymous>";this._profAddSystem(r,performance.now()-n)}else s(this,e)}finally{this._iterateDepth--,this.flush(),this.swapEvents(),this._profAddPhase("update",this._profilingEnabled?performance.now()-t:0),this._profEndFrame(t)}this.updateOverlay(this.stats(),this.statsHistory())}flush(){for(this._ensureNotIterating("flush");;){const e=this.commands.drain();if(e.length===0)break;for(const t of e)this._apply(t)}}registerComponentSnapshot(e,t){return this.snapshotStore.registerComponentSnapshot(this._snapshotRuntime(),e,t),this}unregisterComponentSnapshot(e){return this.snapshotStore.unregisterComponentSnapshot(e)}registerResourceSnapshot(e,t){return this.snapshotStore.registerResourceSnapshot(this._snapshotRuntime(),e,t),this}unregisterResourceSnapshot(e){return this.snapshotStore.unregisterResourceSnapshot(e)}snapshot(){return this.snapshotStore.snapshot(this._snapshotRuntime())}restore(e){this.snapshotStore.restore(this._snapshotRuntime(),e),this.updateOverlay(this.stats(),this.statsHistory())}setResource(e,t){this.resources.set(e,t)}getResource(e){if(this.resources.has(e))return this.resources.get(e)}requireResource(e){if(!this.resources.has(e)){const t=this._formatCtor(e);throw new Error(`requireResource(${t}) failed: resource missing. Insert it via world.setResource(${t}, value) or world.initResource(${t}, () => value).`)}return this.resources.get(e)}hasResource(e){return this.resources.has(e)}removeResource(e){return this.resources.delete(e)}initResource(e,t){if(this.resources.has(e))return this.resources.get(e);const s=t();return this.resources.set(e,s),s}emit(e,t){this._events(e).emit(t)}events(e){return this._events(e)}drainEvents(e,t){const s=this.eventChannels.get(e);s&&s.drain(t)}clearEvents(e){if(e){const t=this.eventChannels.get(e);if(!t)return;t.clear();return}for(const t of this.eventChannels.values())t.clear()}swapEvents(){for(const e of this.eventChannels.values())e.swapBuffers()}spawn(){const e=this.entities.create(),s=this.archetypes[0].addRow(e),n=this.entities.meta[e.id];return n.arch=0,n.row=s,e}spawnMany(...e){const t=this.spawn();for(const[s,n]of e)this.add(t,s,n);return t}isAlive(e){return this.entities.isAlive(e)}despawn(e){this._assertAlive(e,"despawn"),this._ensureNotIterating("despawn"),this._removeFromArchetype(e),this.entities.kill(e)}despawnMany(e){for(const t of e)this.despawn(t)}has(e,t){const s=this.entities.meta[e.id];if(!s||!s.alive||s.gen!==e.gen)return!1;const n=S(t);return this.archetypes[s.arch].has(n)}get(e,t){const s=this.entities.meta[e.id];if(!s||!s.alive||s.gen!==e.gen)return;const n=S(t),r=this.archetypes[s.arch];if(r.has(n))return r.column(n)[s.row]}set(e,t,s){const n=`set(${this._formatCtor(t)})`,r=this._assertAlive(e,n),o=S(t),a=this.archetypes[r.arch];if(!a.has(o))throw new Error(`set(${this._formatCtor(t)}) requires component to exist on ${this._formatEntity(e)}; use add()`);a.column(o)[r.row]=s}add(e,t,s){const n=`add(${this._formatCtor(t)})`;this._assertAlive(e,n),this._ensureNotIterating(n);const r=S(t),o=this.entities.meta[e.id],a=this.archetypes[o.arch];if(a.has(r)){a.column(r)[o.row]=s;return}const i=ne(a.sig,r),c=this._getOrCreateArchetype(i);this._moveEntity(e,a,o.row,c,u=>u===r?s:a.column(u)[o.row])}addMany(e,...t){if(t.length===0)return;this._assertAlive(e,"addMany"),this._ensureNotIterating("addMany");const s=this.entities.meta[e.id],n=this.archetypes[s.arch],r=new Map;for(const[i,c]of t){const u=S(i);r.set(u,c)}const o=n.sig.slice();for(const i of r.keys())if(n.has(i))n.column(i)[s.row]=r.get(i),r.delete(i);else{let c=0;for(;c<o.length&&o[c]<i;)c++;o[c]!==i&&o.splice(c,0,i)}if(r.size===0)return;const a=this._getOrCreateArchetype(o);this._moveEntity(e,n,s.row,a,i=>r.has(i)?r.get(i):n.column(i)[s.row])}remove(e,t){const s=`remove(${this._formatCtor(t)})`;this._assertAlive(e,s),this._ensureNotIterating(s);const n=S(t),r=this.entities.meta[e.id],o=this.archetypes[r.arch];if(!o.has(n))return;const a=ie(o.sig,n),i=this._getOrCreateArchetype(a);this._moveEntity(e,o,r.row,i,c=>o.column(c)[r.row])}removeMany(e,...t){if(t.length===0)return;this._assertAlive(e,"removeMany"),this._ensureNotIterating("removeMany");const s=this.entities.meta[e.id],n=this.archetypes[s.arch],r=new Set;for(const i of t){const c=S(i);n.has(c)&&r.add(c)}if(r.size===0)return;const o=n.sig.filter(i=>!r.has(i)),a=this._getOrCreateArchetype(o);this._moveEntity(e,n,s.row,a,i=>n.column(i)[s.row])}query(...e){const{requested:t,needSorted:s}=$._buildQueryTypeIds(e);function*n(r){r._iterateDepth++;try{for(const o of r.archetypes){if(!o||!z(o.sig,s))continue;const a=new Array(t.length);for(let i=0;i<t.length;i++)a[i]=o.column(t[i]);for(let i=0;i<o.entities.length;i++){const u={e:o.entities[i]};for(let l=0;l<a.length;l++)u[`c${l+1}`]=a[l][i];yield u}}}finally{r._iterateDepth--}}return n(this)}queryTables(...e){const{requested:t,needSorted:s}=$._buildQueryTypeIds(e);function*n(r){r._iterateDepth++;try{for(const o of r.archetypes){if(!o||!z(o.sig,s))continue;const a={entities:o.entities};for(let i=0;i<t.length;i++)a[`c${i+1}`]=o.column(t[i]);yield a}}finally{r._iterateDepth--}}return n(this)}queryEach(...e){const t=e[e.length-1],s=e.slice(0,e.length-1),{requested:n,needSorted:r}=$._buildQueryTypeIds(s);this._iterateDepth++;try{for(const o of this.archetypes){if(!o||!z(o.sig,r))continue;const a=new Array(n.length);for(let i=0;i<n.length;i++)a[i]=o.column(n[i]);for(let i=0;i<o.entities.length;i++){const c=o.entities[i];switch(a.length){case 1:t(c,a[0][i]);break;case 2:t(c,a[0][i],a[1][i]);break;case 3:t(c,a[0][i],a[1][i],a[2][i]);break;case 4:t(c,a[0][i],a[1][i],a[2][i],a[3][i]);break;case 5:t(c,a[0][i],a[1][i],a[2][i],a[3][i],a[4][i]);break;case 6:t(c,a[0][i],a[1][i],a[2][i],a[3][i],a[4][i],a[5][i]);break;default:t(c,...a.map(u=>u[i]));break}}}}finally{this._iterateDepth--}}_snapshotRuntime(){return{ensureNotIterating:e=>this._ensureNotIterating(e),formatCtor:e=>this._formatCtor(e),flush:()=>this.flush(),resetArchetypes:()=>this._resetArchetypes(),getOrCreateArchetype:e=>this._getOrCreateArchetype(e),commands:this.commands,entities:this.entities,archetypes:this.archetypes,resources:this.resources,eventChannels:this.eventChannels}}_resetArchetypes(){this.archetypes.length=0,this.archByKey.clear();const e=new K(0,[]);this.archetypes[0]=e,this.archByKey.set("",e)}static _buildQueryTypeIds(e){const t=new Array(e.length);for(let r=0;r<e.length;r++)t[r]=S(e[r]);const s=t.slice();s.sort((r,o)=>r-o);let n=0;for(let r=0;r<s.length;r++){const o=s[r];(r===0||o!==s[n-1])&&(s[n++]=o)}return s.length=n,{requested:t,needSorted:s}}_ensureNotIterating(e){if(this._iterateDepth>0)throw new Error(`Cannot do structural change (${e}) while iterating. Use world.cmd() and flush at end of frame.`)}_getOrCreateArchetype(e){const t=se(e),s=this.archByKey.get(t);if(s)return s;const n=this.archetypes.length,r=new K(n,e.slice().sort((o,a)=>o-a));return this.archetypes[n]=r,this.archByKey.set(t,r),r}_removeFromArchetype(e){const t=this.entities.meta[e.id],n=this.archetypes[t.arch].removeRow(t.row);if(n){const r=this.entities.meta[n.id];r.row=t.row}}_moveEntity(e,t,s,n,r){const o=n.addRow(e);for(const c of n.sig)n.column(c).push(r(c));const a=this.entities.meta[e.id];a.arch=n.id,a.row=o;const i=t.removeRow(s);if(i){const c=this.entities.meta[i.id];c.arch=t.id,c.row=s}}_apply(e){switch(e.k){case"spawn":{const t=this.spawn();e.init?.(t);return}case"despawn":return this.despawn(e.e);case"add":return this.add(e.e,e.ctor,e.value);case"remove":return this.remove(e.e,e.ctor)}}_formatEntity(e){return`e#${e.id}@${e.gen}`}_formatCtor(e){const t=e?.name;return t&&t.length>0?t:"<token>"}_assertAlive(e,t){const s=this.entities.meta[e.id];if(!this.entities.isAlive(e)){const n=s?`alive=${s.alive}, gen=${s.gen}`:"not found";throw new Error(`${t} failed: stale entity ${this._formatEntity(e)} (${n})`)}return s}_events(e){let t=this.eventChannels.get(e);return t||(t=new te,this.eventChannels.set(e,t)),t}_warnAboutLifecycleConflict(e){const t=e==="World.update"?"You have systems registered via schedule.add() but are calling world.update().":"You have systems registered via world.addSystem() but are calling schedule.run().";throw new Error(`âš ï¸  ECS Lifecycle Conflict Detected!
${t}
This can cause:
- Double command flushes
- Confusing event visibility
- Unclear lifecycle semantics

Recommended fix:
- Use World.update() for simple single-phase applications (with world.addSystem())
- Use Schedule.run() for multi-phase applications (with schedule.add())

Choose ONE approach and stick with it.`)}_getSystemCount(){return this.systems.length}}class ae{constructor(){this.phaseOrder=void 0,this.boundaryMode="auto",this.phaseEdges=new Map,this._lastPhase=void 0}setOrder(e){return this.phaseOrder=e.slice(),this}setBoundaryMode(e){return this.boundaryMode=e,this}add(e,t,s){const n=e._scheduleSystems,r=n.get(t)??[];return r.push(s),n.set(t,r),this._lastPhase=t,this}after(e){if(!this._lastPhase)throw new Error(`Schedule.after("${e}") must be called after schedule.add(world, phase, fn).`);return this._addPhaseConstraint(e,this._lastPhase),this}before(e){if(!this._lastPhase)throw new Error(`Schedule.before("${e}") must be called after schedule.add(world, phase, fn).`);return this._addPhaseConstraint(this._lastPhase,e),this}run(e,t,s){const n=e;n._getSystemCount()>0&&n._warnAboutLifecycleConflict("Schedule.run");const r=s??this.phaseOrder??this._computePhaseOrder(e);if(!r||r.length===0)throw new Error("Schedule.run requires a phase order (pass it as an argument or call schedule.setOrder([...]))");const o=n._profBeginFrame(t);for(const a of r){const i=performance.now(),c=e._scheduleSystems.get(a);if(c)for(const u of c){const l=performance.now();try{u(e,t)}catch(d){const f=u.name&&u.name.length>0?u.name:"<anonymous>",g=d.message!==void 0&&typeof d.message=="string"?d.message:JSON.stringify(d),p=new Error(`[phase=${a} system=${f}] ${g}`);throw p.cause=d,p}finally{const d=u.name&&u.name.length>0?u.name:"<anonymous>";n._profAddSystem(`${a}:${d}`,performance.now()-l)}}this.boundaryMode!=="manual"&&(e.cmd().hasPending()&&e.flush(),e.swapEvents()),n._profAddPhase(a,performance.now()-i)}n._profEndFrame(o),n.updateOverlay(n.stats(),n.statsHistory())}_addPhaseConstraint(e,t){if(e===t)throw new Error(`Invalid phase constraint: "${e}" cannot be before/after itself.`);let s=this.phaseEdges.get(e);s||(s=new Set,this.phaseEdges.set(e,s)),s.add(t)}_computePhaseOrder(e){const t=e._scheduleSystems,s=new Set;for(const l of t.keys())s.add(l);for(const[l,d]of this.phaseEdges){s.add(l);for(const f of d)s.add(f)}const n=new Map;let r=0;for(const l of t.keys())n.set(l,r++);const o=l=>n.get(l)??Number.MAX_SAFE_INTEGER,a=new Map,i=new Map;for(const l of s)a.set(l,0),i.set(l,new Set);for(const[l,d]of this.phaseEdges){const f=i.get(l);for(const g of d)f.has(g)||(f.add(g),a.set(g,(a.get(g)??0)+1))}const c=[];for(const[l,d]of a)d===0&&c.push(l);c.sort((l,d)=>o(l)-o(d)||l.localeCompare(d));const u=[];for(;c.length>0;){const l=c.shift();u.push(l);for(const d of i.get(l)){const f=(a.get(d)??0)-1;a.set(d,f),f===0&&(c.push(d),c.sort((g,p)=>o(g)-o(p)||g.localeCompare(p)))}}if(u.length!==s.size){const l=[...s].filter(d=>(a.get(d)??0)>0).sort();throw new Error(`Schedule phase constraints contain a cycle (cannot compute order). Phases involved: ${l.join(", ")}`)}return u}}class m{constructor(e=0,t=0){this.x=e,this.y=t}}class C{constructor(e=0,t=0){this.x=e,this.y=t}}class y{constructor(e=10){this.radius=e}}class M{}const k=(()=>({kind:"star"}));class b{constructor(e=0,t=3,s=.5,n=!0){this.score=e,this.lives=t,this.spawnTimer=s,this.running=n}}const I=(()=>({intervalMin:.3,intervalMax:.72,starChance:.72,starSpeed:150,bombSpeed:220}));class F{constructor(e,t){this.kind=e,this.x=t}}class O{constructor(e){this.kind=e}}const he=320,H=42,ce=16,le=10,de=12;function N(h,e){return h+Math.random()*(e-h)}function ue(h){window.addEventListener("keydown",e=>{switch(e.code){case"ArrowLeft":case"KeyA":h.leftHeld=!0,e.preventDefault();return;case"ArrowRight":case"KeyD":h.rightHeld=!0,e.preventDefault();return;case"KeyS":e.repeat||h.actions.push("save"),e.preventDefault();return;case"KeyL":e.repeat||h.actions.push("load"),e.preventDefault();return;case"KeyR":e.repeat||h.actions.push("reset"),e.preventDefault();return;default:return}}),window.addEventListener("keyup",e=>{switch(e.code){case"ArrowLeft":case"KeyA":h.leftHeld=!1,e.preventDefault();return;case"ArrowRight":case"KeyD":h.rightHeld=!1,e.preventDefault();return;default:return}})}function fe(h,e){h.setResource(b,new b),h.setResource(I,{intervalMin:.3,intervalMax:.72,starChance:.72,starSpeed:150,bombSpeed:220});const t=h.spawn();h.addMany(t,[M,new M],[m,new m(e.width*.5,e.height-H)],[C,new C(0,0)],[y,new y(ce)])}function ge(h){const e={key:"comp.position",serialize:i=>({x:i.x,y:i.y}),deserialize:i=>new m(i.x,i.y)},t={key:"comp.velocity",serialize:i=>({x:i.x,y:i.y}),deserialize:i=>new C(i.x,i.y)},s={key:"comp.circle",serialize:i=>({radius:i.radius}),deserialize:i=>new y(i.radius)},n={key:"tag.player",serialize:()=>!0,deserialize:()=>new M},r={key:"comp.falling-kind",serialize:i=>({kind:i.kind}),deserialize:i=>({kind:i.kind})},o={key:"res.game-state",serialize:i=>({score:i.score,lives:i.lives,spawnTimer:i.spawnTimer,running:i.running}),deserialize:i=>new b(i.score,i.lives,i.spawnTimer,i.running)},a={key:"res.spawn-config",serialize:i=>({...i}),deserialize:i=>({...i})};h.registerComponentSnapshot(m,e),h.registerComponentSnapshot(C,t),h.registerComponentSnapshot(y,s),h.registerComponentSnapshot(M,n),h.registerComponentSnapshot(k,r),h.registerResourceSnapshot(b,o),h.registerResourceSnapshot(I,a)}function pe(h,e,t,s){const n=e==="star"?le:de;h.cmd().spawnBundle([m,new m(t,-n-4)],[C,new C(0,s)],[y,new y(n)],[k,{kind:e}])}function me(h){return(e,t)=>{h.ttl<=0||(h.ttl=Math.max(0,h.ttl-t))}}function ye(h,e){return(t,s)=>{const n=t.requireResource(b),r=(h.leftHeld?-1:0)+(h.rightHeld?1:0);if(t.queryEach(C,M,(o,a,i)=>{a.x=n.running?r*he:0,a.y=0}),h.actions.length!==0){for(const o of h.actions)e.push(o);h.actions.length=0}}}function we(h){return(e,t)=>{const s=e.requireResource(b);if(s.running){const n=e.requireResource(I);for(s.spawnTimer-=t;s.spawnTimer<=0;){s.spawnTimer+=N(n.intervalMin,n.intervalMax);const r=Math.random()<n.starChance?"star":"bomb",o=N(24,Math.max(24,h.width-24));e.emit(F,new F(r,o))}}e.queryEach(m,C,(n,r,o)=>{r.x+=o.x*t,r.y+=o.y*t}),e.queryEach(m,y,M,(n,r,o,a)=>{const i=o.radius,c=Math.max(i,h.width-o.radius);r.x<i&&(r.x=i),r.x>c&&(r.x=c),r.y=h.height-H});for(const{e:n,c1:r,c2:o}of e.query(m,y,k))r.y-o.radius>h.height+8&&e.cmd().despawn(n)}}function ve(h,e){const t=h.requireResource(I);h.drainEvents(F,s=>{const n=s.kind==="star"?t.starSpeed:t.bombSpeed;pe(h,s.kind,s.x,n)})}function _e(h,e){let t=!1,s=0,n=0,r=0;for(const{c1:a,c2:i}of h.query(m,y,M)){s=a.x,n=a.y,r=i.radius,t=!0;break}if(!(!t||!h.requireResource(b).running))for(const{e:a,c1:i,c2:c,c3:u}of h.query(m,y,k)){const l=i.x-s,d=i.y-n,f=r+c.radius;l*l+d*d>f*f||(h.cmd().despawn(a),h.emit(O,new O(u.kind)))}}function Se(h,e){const t=h.requireResource(b);h.drainEvents(O,s=>{if(s.kind==="star"){t.score+=10;return}t.lives=Math.max(0,t.lives-1),t.lives===0&&(t.running=!1)})}function be(h,e,t){return(s,n)=>{h.clearRect(0,0,e.width,e.height);const r=h.createLinearGradient(0,0,0,e.height);r.addColorStop(0,"#0a1528"),r.addColorStop(1,"#09101a"),h.fillStyle=r,h.fillRect(0,0,e.width,e.height);for(const i of s.queryTables(m,y,k))for(let c=0;c<i.entities.length;c++){const u=i.c1[c],l=i.c2[c],d=i.c3[c];h.beginPath(),h.arc(u.x,u.y,l.radius,0,Math.PI*2),h.fillStyle=d.kind==="star"?"#7ef9ff":"#ff6b6b",h.fill()}for(const{c1:i,c2:c}of s.query(m,y,M))h.beginPath(),h.arc(i.x,i.y,c.radius,0,Math.PI*2),h.fillStyle="#b5ff7e",h.fill(),h.beginPath(),h.arc(i.x,i.y,c.radius+3,0,Math.PI*2),h.strokeStyle="rgba(181, 255, 126, 0.35)",h.lineWidth=2,h.stroke();const o=s.requireResource(b),a=s.stats();h.fillStyle="#eaf2ff",h.font="16px monospace",h.fillText(`Score: ${o.score}`,14,24),h.fillText(`Lives: ${o.lives}`,14,44),h.fillText(`Entities: ${a.aliveEntities}`,14,64),h.fillStyle="#9db5d0",h.fillText("Move: A/D or Arrows",14,e.height-48),h.fillText("Save: S | Load: L | Reset: R",14,e.height-28),o.running||(h.fillStyle="rgba(0, 0, 0, 0.45)",h.fillRect(0,0,e.width,e.height),h.fillStyle="#ffffff",h.font="bold 28px monospace",h.textAlign="center",h.fillText("Game Over",e.width*.5,e.height*.5-8),h.font="16px monospace",h.fillStyle="#cfe0ff",h.fillText("Press R to restore the initial snapshot",e.width*.5,e.height*.5+22),h.textAlign="start"),t.ttl>0&&(h.fillStyle="rgba(12, 20, 34, 0.86)",h.fillRect(12,76,420,30),h.strokeStyle="rgba(147, 199, 255, 0.45)",h.strokeRect(12,76,420,30),h.fillStyle="#9ce3ff",h.font="14px monospace",h.fillText(t.message,22,96))}}function Ce(){const h=document.querySelector("#appCanvas");if(!h)throw new Error("Missing #appCanvas element in example/index.html");const e=h.getContext("2d");if(!e)throw new Error("2D canvas context unavailable");document.title="archetype-ecs-lib | Falling Stars",document.body.style.margin="0",document.body.style.background="#060b14",document.body.style.display="grid",document.body.style.placeItems="center",h.style.border="2px solid #1d2f48",h.style.borderRadius="10px",h.style.boxShadow="0 22px 60px rgba(0, 0, 0, 0.45)";const t={width:960,height:540},s={leftHeld:!1,rightHeld:!1,actions:[]},n={message:"",ttl:0},r=[];ue(s);const o=new $,a=new ae;o.setDebugging(!0),o.setProfilingEnabled(!0),o.setProfilingHistorySize(240),ge(o),fe(o,t);let i=null;const c=o.snapshot(),u=me(n),l=ye(s,r),d=we(t),f=be(e,t,n);a.add(o,"begin",u),a.add(o,"input",l).after("begin"),a.add(o,"simulate",d).after("input"),a.add(o,"spawn",ve).after("simulate"),a.add(o,"collide",_e).after("spawn"),a.add(o,"resolve",Se).after("collide"),a.add(o,"render",f).after("resolve");const g=()=>{const w=Math.min(window.innerWidth-24,960),R=Math.min(window.innerHeight-24,540);t.width=Math.max(480,Math.floor(w)),t.height=Math.max(300,Math.floor(R));const v=Math.max(1,window.devicePixelRatio||1);h.width=Math.floor(t.width*v),h.height=Math.floor(t.height*v),h.style.width=`${t.width}px`,h.style.height=`${t.height}px`,e.setTransform(v,0,0,v,0,0)};window.addEventListener("resize",g),g();const p=w=>{n.message=w,n.ttl=2.2};let A=performance.now();const E=w=>{const R=Math.min(.05,(w-A)/1e3);if(A=w,a.run(o,R),r.length>0){for(const v of r){if(v==="save"){i=o.snapshot(),p("Snapshot saved (S)");continue}if(v==="load"){if(!i){p("No quick-save yet. Press S first.");continue}console.log(i),o.restore(i),p("Snapshot restored (L)");continue}o.restore(c),p("Run reset to initial snapshot (R)")}r.length=0}requestAnimationFrame(E)};requestAnimationFrame(E)}Ce();
